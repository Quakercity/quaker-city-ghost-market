<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quaker City — Contraband System</title>

<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg:#071027;
  --panel:#0f1a2a;
  --accent:#dc143c;
  --accent-2:#0047ab;
  --muted:#b0b8c0;
  --text:#ffffff;
  --glass: rgba(255,255,255,.03);
  --glass-border: rgba(255,255,255,.04);
  --card-radius:14px;
  --maxw:1300px;
  --kill-glow: 0 12px 40px rgba(220,20,60,0.12);
}

/* base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Rajdhani",sans-serif;background:
  radial-gradient(900px 420px at 10% -10%, rgba(220,20,60,.06), transparent 60%),
  radial-gradient(900px 420px at 110% 10%, rgba(0,71,171,.06), transparent 60%),
  linear-gradient(180deg,var(--bg),#031022 120%);
color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:28px;display:flex;justify-content:center;}

.background-logo{
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  width:900px; height:900px; background:url('Quaker.png') no-repeat center/contain;
  filter: blur(20px) saturate(.9); opacity:.10; pointer-events:none; z-index:1;
}
@media(max-width:1024px){ .background-logo{ width:700px;height:700px; filter:blur(16px); opacity:.08 } }
@media(max-width:640px){ .background-logo{ width:480px;height:480px; filter:blur(12px); opacity:.06 } }

.wrap{ width:100%; max-width:var(--maxw); margin:0 auto; position:relative; z-index:6; }
.container{ background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  border-radius:18px; padding:22px; border:1px solid var(--glass-border); box-shadow:0 22px 60px rgba(0,0,0,.6); backdrop-filter: blur(8px); }

/* header */
.header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:18px; }
.header-left{ max-width:70%; }
.title{ font-size:44px; margin:0; line-height:1; font-weight:900; color:var(--accent); text-shadow:0 8px 24px rgba(0,0,0,.6); }
.subtitle{ margin-top:8px; color:var(--muted); font-weight:700; }

/* topnav */
.topnav{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center; }
.topnav .cat{ padding:10px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  color:var(--muted); border:1px solid rgba(255,255,255,.03); font-weight:800; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
.topnav .cat.active{ color:var(--text); border-color: rgba(220,20,60,.28); box-shadow: var(--kill-glow); background: linear-gradient(180deg, rgba(220,20,60,.06), rgba(0,71,171,.03)); }

/* subtabs row */
.subtabs{ margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.subtabs .sub{ padding:8px 12px; border-radius:999px; background: linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.03); color:var(--muted); font-weight:800; cursor:pointer; transition:all .16s ease; }
.subtabs .sub.active{ color:var(--text); background: linear-gradient(180deg, rgba(220,20,60,.12), rgba(0,71,171,.06)); box-shadow: var(--kill-glow); border-color: rgba(220,20,60,.28); transform:translateY(-2px); }

/* header right */
.header-right{ display:flex; align-items:center; gap:12px; }
.logo{ width:86px; height:86px; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); }
.header-logo{ width:72px; height:72px; object-fit:contain; }

/* controls */
.controls{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px; }
.controls .left{ display:flex; gap:10px; align-items:center; }
.choose{ color:var(--muted); font-weight:800; margin-right:6px; }
select{ background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.04); color:var(--text); padding:8px 10px; border-radius:10px; font-weight:800; }

.drop-actions{ display:flex; gap:10px; align-items:center; }
.btn{ padding:10px 14px; border-radius:10px; font-weight:900; cursor:pointer; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); color:var(--text); }
.btn.drop{ background: linear-gradient(180deg, rgba(220,20,60,.95), rgba(160,10,40,.85)); box-shadow: var(--kill-glow); color:white; }

/* music toggle (right aligned) */
.music-toggle{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(0,0,0,.14), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.04); color:var(--muted); font-weight:800; cursor:pointer; }
.music-toggle.on{ color:var(--accent); box-shadow: 0 10px 30px rgba(220,20,60,.09); }

/* grid */
.grid-wrap{ margin-top:16px; border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,.03); background: linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0)); box-shadow: inset 0 6px 20px rgba(0,0,0,.3); }
.grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(190px,1fr)); gap:14px; align-items:stretch; }

/* card */
.card{ border-radius:12px; padding:10px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.04); min-height:220px; display:flex; flex-direction:column; position:relative; overflow:visible; }
.card .top-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.card .name{ font-weight:900; color:var(--muted); font-size:15px; }
.img-wrap{ flex:1 1 auto; display:flex; align-items:center; justify-content:center; padding:6px; background: linear-gradient(180deg, rgba(0,0,0,.06), rgba(255,255,255,0)); border-radius:8px; margin-bottom:8px; }
.img-wrap img{ max-width:100%; max-height:110px; object-fit:contain; display:block; }

/* stats area inside card */
.stats-row{ display:flex; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted); font-weight:800; }
.stats-block{ display:flex; flex-direction:column; align-items:flex-start; gap:4px; }

/* rarity badge */
.badge{ position:absolute; left:10px; bottom:10px; background:linear-gradient(180deg, rgba(0,0,0,.36), rgba(255,255,255,.02)); padding:6px 8px; border-radius:8px; font-weight:900; color:var(--muted); border:1px solid rgba(255,255,255,.03); font-size:12px; }

/* turf map placeholder */
.turf-map{ width:100%; height:420px; border-radius:12px; overflow:hidden; background:linear-gradient(180deg, rgba(0,0,0,.16), rgba(255,255,255,0)); display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.04); }

/* acquired list */
.acquired-heading{ margin-top:18px; font-weight:900; color:var(--accent); }
.acquired-grid{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; }

/* modals */
.modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); z-index:9999; }
.modal-overlay.open{ display:flex; }
.modal{ width:920px; max-width:96%; border-radius:12px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); box-shadow: 0 22px 60px rgba(0,0,0,.6); }

/* small screens */
@media(max-width:980px){ .title{ font-size:34px } .grid{ grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); } .img-wrap img{ max-height:90px; } .modal{ width:92% } }
@media(max-width:640px){ .title{ font-size:26px } .grid{ grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); } .img-wrap img{ max-height:76px; } }
</style>
</head>
<body>
  <div class="background-logo" aria-hidden="true"></div>

  <div class="wrap">
    <div class="header">
      <div class="header-left">
        <h1 class="title">Quaker City</h1>
        <div class="subtitle">Contraband System</div>

        <div class="topnav" id="mainNav">
          <div class="cat active" data-tab="tier1"><i class="fa-solid fa-gun"></i>&nbsp;Tier 1 Weaponry</div>
          <div class="cat" data-tab="tier2"><i class="fa-solid fa-shield"></i>&nbsp;Tier 2 Weaponry</div>
          <div class="cat" data-tab="attachments"><i class="fa-solid fa-wrench"></i>&nbsp;Attachments</div>
          <div class="cat" data-tab="drugs"><i class="fa-solid fa-capsules"></i>&nbsp;Drugs</div>
          <div class="cat" data-tab="turf"><i class="fa-solid fa-map"></i>&nbsp;Turf Map</div>
        </div>

        <div class="subtabs" id="subtabs"></div>
      </div>

      <div class="header-right">
        <div id="musicToggle" class="music-toggle" title="Toggle Music"><i class="fa-solid fa-volume-high"></i>&nbsp;<span id="musicLabel">Music: On</span></div>
        <div id="adminToggle" class="admin-flag" title="Admin"><i class="fa-solid fa-user-lock"></i></div>
        <div class="logo"><img src="Quaker.png" class="header-logo" alt="Quaker logo"></div>
      </div>
    </div>

    <div class="container">
      <div class="controls">
        <div class="left">
          <div class="choose">Filter</div>
          <select id="filterSelect">
            <option value="all">All</option>
            <option value="common">Common</option>
            <option value="uncommon">Uncommon</option>
            <option value="rare">Rare</option>
            <option value="epic">Epic</option>
            <option value="legendary">Legendary</option>
          </select>
        </div>

        <div class="drop-actions">
          <button class="btn" id="viewDropsBtn"><i class="fa-solid fa-list"></i>&nbsp;Drops</button>
          <button class="btn drop" id="dropBtn"><i class="fa-solid fa-dice"></i>&nbsp;DROP</button>
        </div>
      </div>

      <div class="grid-wrap" id="contentArea">
        <div class="grid" id="itemGrid" aria-live="polite"></div>
      </div>

      <div class="acquired-heading">Acquired Items</div>
      <div class="acquired-grid" id="acquiredGrid"></div>

      <div style="display:flex; gap:12px; margin-top:14px; align-items:flex-start; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px;">
          <div class="info-panel" id="infoPanel">Click a card to preview more info. Use DROP to open the spin modal and receive a weighted drop.</div>
        </div>
        <div style="width:320px;">
          <div class="info-panel">
            <div style="font-weight:900">Made By Route</div>
            <div style="color:var(--muted); margin-top:8px;" id="lastUpdated">Last updated: —</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>
    <div class="footer"><div>© Quaker City Roleplay</div><div style="color:var(--muted)">Built with ❤️</div></div>
  </div>

  <!-- Spin modal -->
  <div class="modal-overlay" id="spinModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; font-size:18px;">Spin Wheel</div>
        <div style="color:var(--muted); font-weight:800;">Click SPIN to start</div>
      </div>

      <div style="position:relative; margin-top:12px;">
        <div id="spinStrip" style="height:140px; display:flex; gap:12px; align-items:center; overflow:hidden; padding:10px;"></div>
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:6px; height:120px; border-radius:6px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: 0 0 24px rgba(255,200,0,.08); pointer-events:none;"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
        <button class="btn" id="closeSpin">Close</button>
        <button class="btn drop" id="spinStartBtn">SPIN</button>
      </div>
    </div>
  </div>

  <!-- stats modal (card click will also show small details modal if needed, but per your choice we show stats in card) -->
  <div class="modal-overlay" id="statsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div id="statsTitle" style="font-weight:900;"></div>
        <button class="btn" id="closeStats"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div style="display:flex; gap:12px; margin-top:12px;">
        <div style="flex:0 0 220px; height:140px; border-radius:10px; overflow:hidden; background:rgba(0,0,0,.06); display:flex; align-items:center; justify-content:center;">
          <img id="statsImg" src="" alt="" style="max-width:100%; max-height:100%; object-fit:contain;">
        </div>
        <div style="flex:1;">
          <div id="statsRarity" style="color:var(--muted); font-weight:900;"></div>
          <div id="statsDetails" style="margin-top:12px; color:var(--muted);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- admin panel -->
  <div class="admin-panel" id="adminPanel" aria-hidden="true">
    <h3 style="margin:6px 0 12px;">Admin Panel</h3>
    <label>Discord Webhook</label>
    <input id="adminWebhook" type="text" placeholder="https://discord.com/api/webhooks/..." style="width:100%; margin-bottom:8px;">
    <label>Server Uptime</label>
    <input id="adminUptime" type="text" placeholder="http://example.com/health" style="width:100%; margin-bottom:8px;">
    <label>Price JSON URL</label>
    <input id="adminPrices" type="text" placeholder="https://raw.githubusercontent.com/.../prices.json" style="width:100%; margin-bottom:8px;">
    <hr style="border-color:rgba(255,255,255,.03); margin:8px 0;">
    <div style="display:flex; gap:8px;">
      <button class="btn" id="saveAdminBtn">Save</button>
      <button class="btn" id="logoutAdminBtn">Logout</button>
    </div>
    <div style="color:var(--muted); margin-top:10px; font-size:13px;">Admin password (client-side): <b>Qacti</b></div>
  </div>

  <!-- turf image placeholder (hidden until Turf tab) -->
  <div id="turfPlaceHolder" style="display:none">
    <!-- shown inside content area when Turf tab active -->
  </div>

  <!-- audio -->
  <audio id="bgm" src="OceanEyes.mp3" loop preload="auto"></audio>

<script>
/* =============================
   Quaker City — Single-file app
   ============================= */

/* ---------- IMAGES - point to your images/ folder if you uploaded real images ---------- */
/* If you uploaded images into repo root or images/ folder, adjust these paths to match filenames exactly.
   E.g. 'images/ghost_glock_17.png' */
const IMAGES = {
  'Ghost Glock 17': 'images/ghost_glock_17.png',
  'Glock 19': 'images/glock_19.png',
  'Glock 20': 'images/glock_20.png',
  'Beretta M9': 'images/beretta_m9.png',
  'CZ 75': 'images/cz_75.png',
  'Hi-Point': 'images/hi_point.png',
  'Tec-9': 'images/tec9.png',
  'MAC-10': 'images/mac10.png',
  'Micro UZI': 'images/micro_uzi.png',
  'Skorpion': 'images/skorpion.png',
  'MP5': 'images/mp5.png',
  'UMP45': 'images/ump45.png',
  'P90': 'images/p90.png',
  'AK-47': 'images/ak47.png',
  'AR-15': 'images/ar15.png',
  'M4A1': 'images/m4a1.png',
  'Kriss Vector': 'images/kriss_vector.png',
  'ACR': 'images/acr.png'
};
/* fallback placeholder */
const FALLBACK = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="240"%3E%3Crect fill="%23333" width="400" height="240"/%3E%3Ctext x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23999"%3ENo Image%3C/text%3E%3C/svg%3E';

/* ---------- weapon stats (as you provided) ---------- */
const WEAPON_STATS = {
  'Ghost Glock 17': { damage: 28, fire: 750, ammo: '9mm', magStd: 15, magExt: 33 },
  'Glock 19': { damage: 28, fire: 750, ammo: '9mm', magStd: 15, magExt: 33 },
  'Glock 20': { damage: 35, fire: 600, ammo: '.45 ACP', magStd: 10, magExt: 21 },
  'Beretta M9': { damage: 28, fire: 750, ammo: '9mm', magStd: 15, magExt: 30 },
  'CZ 75': { damage: 30, fire: 750, ammo: '9mm', magStd: 16, magExt: 32 },
  'Hi-Point': { damage: 32, fire: 400, ammo: '.45 ACP', magStd: 8, magExt: 16 },
  'Tec-9': { damage: 25, fire: 1000, ammo: '9mm', magStd: 20, magExt: 40 },
  'MAC-10': { damage: 27, fire: 1090, ammo: '.45 ACP', magStd: 30, magExt: 50 },
  'Micro UZI': { damage: 25, fire: 1200, ammo: '9mm', magStd: 25, magExt: 50 },
  'Skorpion': { damage: 23, fire: 1100, ammo: '.32 ACP', magStd: 20, magExt: 40 },
  'MP5': { damage: 26, fire: 800, ammo: '9mm', magStd: 30, magExt: 60 },
  'UMP45': { damage: 30, fire: 600, ammo: '.45 ACP', magStd: 25, magExt: 50 },
  'P90': { damage: 22, fire: 900, ammo: '5.7x28', magStd: 50, magExt: 100 },
  'AK-47': { damage: 36, fire: 600, ammo: '7.62x39', magStd: 30, magExt: 75 },
  'AR-15': { damage: 38, fire: 700, ammo: '5.56x45', magStd: 30, magExt: 60 },
  'M4A1': { damage: 36, fire: 800, ammo: '5.56x45', magStd: 30, magExt: 60 },
  'Kriss Vector': { damage: 34, fire: 1200, ammo: '.45 ACP', magStd: 25, magExt: 50 },
  'ACR': { damage: 40, fire: 750, ammo: '5.56x45', magStd: 30, magExt: 60 }
};

/* ---------- Item lists with categories (Option 2: simple categories) ---------- */
const ITEMS = {
  tier1: [
    { name:'Ghost Glock 17', rarity:'common', category:'Pistols', img:IMAGES['Ghost Glock 17'] || FALLBACK },
    { name:'Glock 19', rarity:'common', category:'Pistols', img:IMAGES['Glock 19'] || FALLBACK },
    { name:'Glock 20', rarity:'common', category:'Pistols', img:IMAGES['Glock 20'] || FALLBACK },
    { name:'Beretta M9', rarity:'uncommon', category:'Pistols', img:IMAGES['Beretta M9'] || FALLBACK },
    { name:'MAC-10', rarity:'rare', category:'SMG', img:IMAGES['MAC-10'] || FALLBACK },
    { name:'MP5', rarity:'rare', category:'SMG', img:IMAGES['MP5'] || FALLBACK },
    { name:'UMP45', rarity:'rare', category:'SMG', img:IMAGES['UMP45'] || FALLBACK },
    { name:'Micro UZI', rarity:'rare', category:'SMG', img:IMAGES['Micro UZI'] || FALLBACK },
    { name:'Skorpion', rarity:'rare', category:'SMG', img:IMAGES['Skorpion'] || FALLBACK },
    { name:'P90', rarity:'epic', category:'SMG', img:IMAGES['P90'] || FALLBACK },
    { name:'FNX-45', rarity:'epic', category:'Pistols', img:FALLBACK }
  ],
  tier2: [
    { name:'AK-47', rarity:'epic', category:'ARs', img:IMAGES['AK-47'] || FALLBACK },
    { name:'M4A1', rarity:'epic', category:'ARs', img:IMAGES['M4A1'] || FALLBACK },
    { name:'AR-15', rarity:'rare', category:'ARs', img:IMAGES['AR-15'] || FALLBACK },
    { name:'ACR', rarity:'legendary', category:'ARs', img:IMAGES['ACR'] || FALLBACK }
  ],
  attachments: [
    { name:'Extended Magazine', rarity:'rare', category:'Mags', img:FALLBACK },
    { name:'Flashlight', rarity:'uncommon', category:'Mags', img:FALLBACK }
  ],
  drugs: [
    { name:'RP 10', rarity:'common', category:'Common', img:FALLBACK },
    { name:'RP 20', rarity:'rare', category:'Rare', img:FALLBACK }
  ]
};

/* ---------- weights (from your config earlier) ---------- */
const DEFAULT_WEIGHTS = {
  tier1: { common:35, uncommon:40, rare:25, epic:10 },
  tier2: { rare:50, epic:40, legendary:10 },
  attachments: { uncommon:50, rare:30, epic:15, legendary:5 },
  drugs: { common:35, uncommon:25, rare:25, epic:15 }
};

/* ---------- DOM refs ---------- */
const mainNav = document.getElementById('mainNav');
const subtabsEl = document.getElementById('subtabs');
const itemGrid = document.getElementById('itemGrid');
const filterSelect = document.getElementById('filterSelect');
const dropBtn = document.getElementById('dropBtn');
const viewDropsBtn = document.getElementById('viewDropsBtn');
const acquiredGrid = document.getElementById('acquiredGrid');
const spinModal = document.getElementById('spinModal');
const spinStrip = document.getElementById('spinStrip');
const spinStartBtn = document.getElementById('spinStartBtn');
const closeSpin = document.getElementById('closeSpin');
const musicToggle = document.getElementById('musicToggle');
const musicLabel = document.getElementById('musicLabel');
const bgm = document.getElementById('bgm');

const adminToggle = document.getElementById('adminToggle');
const adminPanel = document.getElementById('adminPanel');
const saveAdminBtn = document.getElementById('saveAdminBtn');
const logoutAdminBtn = document.getElementById('logoutAdminBtn');
const adminWebhook = document.getElementById('adminWebhook');
const adminUptime = document.getElementById('adminUptime');
const adminPrices = document.getElementById('adminPrices');

const statsModal = document.getElementById('statsModal');
const statsTitle = document.getElementById('statsTitle');
const statsImg = document.getElementById('statsImg');
const statsRarity = document.getElementById('statsRarity');
const statsDetails = document.getElementById('statsDetails');
const closeStats = document.getElementById('closeStats');

let activeTab = 'tier1';
let activeSub = 'Pistols';
let acquired = [];
let spinning = false;

/* ---------- small helpers ---------- */
function tick(ms){ return new Promise(r=> setTimeout(r,ms)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }

/* ---------- config storage ---------- */
function loadCfg(){ try{ return JSON.parse(localStorage.getItem('qc_cfg')||'{}')}catch(e){return{}} }
function saveCfg(c){ localStorage.setItem('qc_cfg', JSON.stringify(c)); }
function getWeights(){ const c = loadCfg(); return c.weights || DEFAULT_WEIGHTS; }
function setWeights(w){ const c = loadCfg(); c.weights = w; saveCfg(c); }

/* ---------- admin (client-side) ---------- */
const ADMIN_PASS = 'Qacti';
function isAdmin(){ return sessionStorage.getItem('qc_admin') === '1'; }
function setAdmin(flag){ if(flag) sessionStorage.setItem('qc_admin','1'); else sessionStorage.removeItem('qc_admin'); adminPanel.style.display = flag ? 'block':'none'; }
adminToggle.addEventListener('click', ()=>{
  if(isAdmin()){ adminPanel.style.display = adminPanel.style.display === 'block' ? 'none':'block'; return; }
  const p = prompt('Enter admin password:'); if(p === ADMIN_PASS){ setAdmin(true); loadAdmin(); alert('Admin ON'); } else alert('Wrong password');
});
logoutAdminBtn.addEventListener('click', ()=> { setAdmin(false); adminPanel.style.display = 'none'; alert('Logged out'); });
saveAdminBtn.addEventListener('click', ()=> {
  if(!isAdmin()){ alert('Admin only'); return; }
  const cfg = loadCfg(); cfg.webhook = adminWebhook.value.trim(); cfg.uptime = adminUptime.value.trim(); cfg.prices = adminPrices.value.trim(); saveCfg(cfg); alert('Saved');
});

/* ---------- subtab sets for Option 2 (simple categories) ---------- */
const SUBTABS = {
  tier1: ['All','Pistols','SMG','ARs','Specials'],
  tier2: ['All','ARs','Snipers','LMGs'],
  attachments: ['All','Mags','Optics','Other'],
  drugs: ['All','Common','Rare']
};

/* ---------- rendering subtabs ---------- */
function renderSubtabs(tab){
  subtabsEl.innerHTML = '';
  const arr = SUBTABS[tab] || ['All'];
  arr.forEach((s,i)=>{
    const el = document.createElement('div');
    el.className = 'sub' + (i===0 ? ' active':'' );
    el.textContent = s;
    el.dataset.sub = s;
    el.addEventListener('click', ()=>{
      document.querySelectorAll('.subtabs .sub').forEach(x=> x.classList.remove('active'));
      el.classList.add('active');
      activeSub = s;
      renderGrid();
    });
    subtabsEl.appendChild(el);
  });
  activeSub = arr[0];
}

/* ---------- items filtering ---------- */
function itemsForTab(tab){
  const arr = (ITEMS[tab]||[]).slice();
  const filter = filterSelect.value;
  let res = arr;
  if(filter !== 'all') res = res.filter(i=> i.rarity === filter);
  if(activeSub && activeSub !== 'All'){
    // match by category (some items might have different category strings)
    res = res.filter(i=> {
      if(!i.category) return true;
      const cat = i.category.toLowerCase();
      return (activeSub.toLowerCase() === cat) || (activeSub.toLowerCase() === 'smg' && cat.includes('smg')) || (activeSub.toLowerCase() === 'pistols' && cat.includes('pist'));
    });
  }
  return res;
}

/* ---------- create card (with stats inside) ---------- */
function createCard(item){
  const s = WEAPON_STATS[item.name] || {};
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <div class="top-row"><div class="name">${item.name}</div></div>
    <div class="img-wrap"><img loading="lazy" src="${item.img}" alt="${item.name}" onerror="this.src='${FALLBACK}'"></div>
    <div class="stats-row">
      <div class="stats-block"><div style="font-size:11px;color:var(--muted)">DMG</div><div style="font-weight:900">${s.damage ?? '-'}</div></div>
      <div class="stats-block"><div style="font-size:11px;color:var(--muted)">FIRE</div><div style="font-weight:900">${s.fire ?? '-'}</div></div>
      <div class="stats-block"><div style="font-size:11px;color:var(--muted)">AMMO</div><div style="font-weight:900">${s.ammo ?? '-'}</div></div>
      <div class="stats-block"><div style="font-size:11px;color:var(--muted)">MAG</div><div style="font-weight:900">${s.magStd ?? '-'} / ${s.magExt ?? '-'}</div></div>
    </div>
    <div class="badge">${(item.rarity||'common').toUpperCase()}</div>
  `;
  el.addEventListener('click', ()=> openCardDetails(item));
  return el;
}

/* ---------- render weapon grid ---------- */
function renderGrid(){
  const nodes = itemsForTab(activeTab);
  itemGrid.innerHTML = '';
  if(activeTab === 'turf'){
    // show turf placeholder
    itemGrid.innerHTML = `<div style="grid-column:1/-1"><div class="turf-map" id="turfMapArea"><div style="text-align:center;color:var(--muted);font-weight:900">Turf Map Placeholder</div></div></div>`;
    return;
  }
  nodes.forEach(it => itemGrid.appendChild(createCard(it)));
}

/* ---------- open card details (small modal) ---------- */
function openCardDetails(item){
  statsTitle.textContent = item.name;
  statsRarity.textContent = (item.rarity||'common').toUpperCase();
  statsImg.src = item.img || FALLBACK;
  const s = WEAPON_STATS[item.name] || {};
  statsDetails.innerHTML = `
    <div style="font-weight:900">${item.name}</div>
    <div style="color:var(--muted); margin-top:8px;">
      Damage: ${s.damage ?? '-'}<br>
      Fire Rate: ${s.fire ? s.fire + ' RPM' : '-'}<br>
      Ammo: ${s.ammo ?? '-'}<br>
      Magazine: ${s.magStd ?? '-'} (Ext ${s.magExt ?? '-'})
    </div>
  `;
  statsModal.classList.add('open'); statsModal.style.display = 'flex';
}
closeStats.addEventListener('click', ()=> { statsModal.classList.remove('open'); statsModal.style.display='none'; });
document.getElementById('statsModal').addEventListener('click', (e)=> { if(e.target.id === 'statsModal'){ statsModal.classList.remove('open'); statsModal.style.display='none'; } });

/* ---------- navigation wiring ---------- */
document.querySelectorAll('.topnav .cat').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('.topnav .cat').forEach(x=> x.classList.remove('active'));
    el.classList.add('active');
    activeTab = el.dataset.tab;
    renderSubtabs(activeTab);
    renderGrid();
    // show turf content differently
    if(activeTab === 'turf'){
      document.getElementById('contentArea').innerHTML = `<div class="turf-map"><img src="images/turf_placeholder.png" onerror="this.style.filter='grayscale(.3)'; this.alt='Upload turf image to images/turf_placeholder.png';" style="max-width:100%; max-height:100%; object-fit:cover;"></div>`;
    } else {
      document.getElementById('contentArea').innerHTML = `<div class="grid-wrap"><div class="grid" id="itemGrid"></div></div>`;
      // rebind itemGrid ref
      window.requestAnimationFrame(()=> {
        if(document.getElementById('itemGrid')) {
          // update ref & re-render
          itemGrid = document.getElementById('itemGrid');
          renderGrid();
        }
      });
    }
  });
});

/* ---------- filter wiring ---------- */
filterSelect.addEventListener('change', ()=> renderGrid());

/* ---------- music toggle functionality ---------- */
function setMusicOn(on){
  localStorage.setItem('qc_music_on', on ? '1' : '0');
  if(on){
    musicToggle.classList.add('on'); musicLabel.textContent = 'Music: On'; musicToggle.querySelector('i').className='fa-solid fa-volume-high';
    bgm.play().catch(()=>{});
  } else {
    musicToggle.classList.remove('on'); musicLabel.textContent = 'Music: Off'; musicToggle.querySelector('i').className='fa-solid fa-volume-xmark';
    bgm.pause();
  }
}
musicToggle.addEventListener('click', ()=>{
  const on = localStorage.getItem('qc_music_on') === '1';
  setMusicOn(!on);
});
// start music after user interacts (autoplay rules)
function enableBGM(){
  function start(){ if(bgm){ bgm.play().catch(()=>{}); } document.removeEventListener('click', start); document.removeEventListener('touchstart', start); }
  document.addEventListener('click', start); document.addEventListener('touchstart', start);
}
enableBGM();
const musicPref = localStorage.getItem('qc_music_on');
setTimeout(()=> setMusicOn(musicPref !== '0'), 120);

/* ---------- spinner modal (DROP) ---------- */
function openSpinModal(){
  spinStrip.innerHTML = '';
  spinModal.classList.add('open'); spinModal.style.display='flex';
  // build visual strip from current activeTab pool
  const pool = (ITEMS[activeTab]||[]).slice();
  if(pool.length === 0){ spinStrip.innerHTML = '<div style="color:var(--muted)">No items in this category.</div>'; return; }
  for(let i=0;i<40;i++){
    const it = rand(pool);
    const tile = document.createElement('div');
    tile.style.minWidth='140px'; tile.style.height='120px'; tile.style.borderRadius='10px'; tile.style.overflow='hidden';
    tile.style.background='linear-gradient(180deg, rgba(0,0,0,.16), rgba(255,255,255,0))'; tile.style.border='1px solid rgba(255,255,255,.04)';
    tile.style.display='flex'; tile.style.flexDirection='column'; tile.style.alignItems='center'; tile.style.justifyContent='center';
    tile.style.padding='8px'; tile.innerHTML = `<div style="font-weight:900;color:var(--muted);margin-bottom:6px;">${it.name}</div><img src="${it.img}" style="max-width:100%; max-height:64px; object-fit:contain" onerror="this.src='${FALLBACK}'">`;
    spinStrip.appendChild(tile);
  }
}
dropBtn.addEventListener('click', openSpinModal);
viewDropsBtn.addEventListener('click', ()=> {
  if(acquired.length===0) alert('No drops yet'); else window.scrollTo({ top: document.querySelector('.acquired-heading').offsetTop - 60, behavior:'smooth' });
});
closeSpin.addEventListener('click', ()=> { spinModal.classList.remove('open'); spinModal.style.display='none'; });

function pickRarity(weights){
  const entries = Object.entries(weights).filter(([k,v])=> Number(v) > 0);
  const total = entries.reduce((s,[_k,v])=> s + Number(v), 0);
  const r = Math.random() * total; let acc = 0;
  for(const [k,v] of entries){ acc += Number(v); if(r <= acc) return k; }
  return entries[entries.length-1][0];
}
function pickWeightedItem(tabKey){
  const w = getWeights();
  const weights = w[tabKey] || DEFAULT_WEIGHTS[tabKey] || DEFAULT_WEIGHTS.tier1;
  const rarity = pickRarity(weights);
  const pool = (ITEMS[tabKey]||[]).filter(i=> i.rarity === rarity);
  if(pool.length) return rand(pool);
  const all = [].concat(...Object.values(ITEMS));
  return rand(all);
}

spinStartBtn.addEventListener('click', async ()=>{
  if(spinning) return;
  spinning = true;
  // simple visual shift animation
  const shifts = 48 + Math.floor(Math.random()*46);
  for(let i=0;i<shifts;i++){
    if(spinStrip.firstElementChild) spinStrip.appendChild(spinStrip.firstElementChild);
    const progress = i/shifts;
    const delay = 18 + Math.pow(progress,2)*520;
    await tick(delay);
  }
  const picked = pickWeightedItem(activeTab);
  addAcquired(picked);
  sendWebhook({ action:'spin', tier: activeTab, result: picked.name, rarity: picked.rarity, ts: new Date().toISOString() });
  // highlight audible feedback
  playSFX('win');
  // close modal after short pause
  setTimeout(()=> { spinModal.classList.remove('open'); spinModal.style.display='none'; spinning = false; }, 1200);
});

/* ---------- add acquired to UI ---------- */
function addAcquired(item){
  acquired.unshift(item);
  const card = document.createElement('div');
  card.className = 'drop-card';
  card.style.display='flex'; card.style.gap='10px'; card.style.alignItems='center'; card.style.padding='8px'; card.style.borderRadius='10px';
  card.style.border='1px solid rgba(255,255,255,.04)'; card.style.background='linear-gradient(180deg, rgba(255,255,255,.01), rgba(255,255,255,0))';
  card.innerHTML = `<img src="${item.img}" style="width:56px;height:56px;object-fit:contain;border-radius:8px;" onerror="this.src='${FALLBACK}'"><div><div style="font-weight:900">${item.name}</div><div style="color:var(--muted);font-size:12px">${(item.rarity||'common').toUpperCase()}</div></div>`;
  card.addEventListener('click', ()=> openCardDetails(item));
  acquiredGrid.prepend(card);
  while(acquiredGrid.children.length > 120) acquiredGrid.removeChild(acquiredGrid.lastChild);
}

/* ---------- sound effects ---------- */
const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;
function playTone(freq,len=0.08,type='sine',gain=0.06){
  if(!audioCtx) return;
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination);
    const now = audioCtx.currentTime; g.gain.value = 0; g.gain.linearRampToValueAtTime(gain, now + 0.01);
    o.start(now); g.gain.exponentialRampToValueAtTime(0.0001, now + len); o.stop(now + len + 0.02);
  } catch(e){}
}
function playSFX(name){
  if(!audioCtx) return;
  if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  if(name === 'click') playTone(880,0.06,'square',0.05);
  if(name === 'spin') playTone(240,0.12,'sawtooth',0.12);
  if(name === 'win'){ playTone(880,0.08,'sine',0.12); setTimeout(()=>playTone(1320,0.12,'sine',0.11),120); setTimeout(()=>playTone(1760,0.16,'sine',0.09),260); }
}

/* ---------- webhooks ---------- */
function sendWebhook(payload){
  const cfg = loadCfg();
  const webhook = cfg.webhook || '';
  if(!webhook) return;
  fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: `Quaker | ${payload.action} → ${payload.result||''} (${payload.rarity||''}) — ${payload.ts||''}` }) })
    .catch(e=> console.warn('webhook fail', e));
}

/* ---------- startup ---------- */
function init(){
  renderSubtabs(activeTab);
  renderGrid();
  const cfg = loadCfg();
  if(cfg.webhook) adminWebhook.value = cfg.webhook;
  if(cfg.uptime) adminUptime.value = cfg.uptime;
  if(cfg.prices) adminPrices.value = cfg.prices;
  document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
  // music preference
  const mp = localStorage.getItem('qc_music_on');
  setTimeout(()=> setMusicOn(mp !== '0'), 60);
  console.log('Quaker City UI ready. Admin password (client-side):', ADMIN_PASS);
}
function setMusicOn(on){
  localStorage.setItem('qc_music_on', on ? '1':'0');
  if(on){ musicToggle.classList.add('on'); musicLabel.textContent = 'Music: On'; musicToggle.querySelector('i').className='fa-solid fa-volume-high'; bgm.play().catch(()=>{}); }
  else { musicToggle.classList.remove('on'); musicLabel.textContent = 'Music: Off'; musicToggle.querySelector('i').className='fa-solid fa-volume-xmark'; bgm.pause(); }
}

/* ensure first user gesture allows audio context */
document.addEventListener('click', ()=> { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); });
init();

/* allow closing modals with ESC */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ document.querySelectorAll('.modal-overlay.open').forEach(m=>{ m.classList.remove('open'); m.style.display='none'; }); } });

// small accessibility: close modals by clicking backdrop
document.querySelectorAll('.modal-overlay').forEach(m=> m.addEventListener('click', (e)=> { if(e.target === m){ m.classList.remove('open'); m.style.display='none'; } }));

</script>
</body>
</html>
